<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI SaaS Platform (보안 적용 버전)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
        }
        /* 스크롤바 스타일링 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-4xl h-[90vh] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-slate-800 text-white p-4 flex justify-between items-center shadow-md z-10">
            <h1 class="text-xl font-bold">🚀 AI SaaS Platform</h1>
            <div id="tabs" class="flex bg-slate-700 rounded-lg p-1">
                <button id="chat-tab-button" class="tab-button bg-slate-500 text-white px-4 py-1.5 rounded-md text-sm font-semibold">AI 챗봇</button>
                <button id="image-tab-button" class="tab-button text-slate-300 px-4 py-1.5 rounded-md text-sm font-semibold">이미지 생성</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-6">
            <!-- Chatbot UI -->
            <div id="chat-ui">
                <div id="chat-messages" class="h-[calc(80vh-180px)] overflow-y-auto space-y-4 pr-2">
                    <!-- Initial Bot Message -->
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 flex items-center justify-center text-white font-bold text-sm">AI</div>
                        <div class="bg-slate-200 rounded-lg p-3 max-w-lg">
                            <p class="text-sm text-slate-800">안녕하세요! 저는 최신 정보를 검색하고 답변할 수 있는 AI 챗봇입니다. 무엇이든 물어보세요.</p>
                        </div>
                    </div>
                </div>
                <!-- Chat Input -->
                <div class="mt-4 flex items-center gap-2">
                    <input type="text" id="chat-input" class="flex-1 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="메시지를 입력하세요...">
                    <button id="send-button" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-slate-400">
                        전송
                    </button>
                </div>
            </div>

            <!-- Image Generation UI (Initially Hidden) -->
            <div id="image-ui" class="hidden">
                 <div class="flex flex-col items-center justify-center h-full">
                    <div class="w-full max-w-2xl text-center">
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">AI 이미지 생성</h2>
                        <p class="text-slate-500 mb-6">생성하고 싶은 이미지에 대한 설명을 입력해주세요.</p>
                        <div class="flex items-center gap-2 mb-6">
                            <input type="text" id="image-prompt" class="flex-1 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition" placeholder="예: 밤하늘을 나는 우주 고양이, 유화 스타일">
                            <button id="generate-image-button" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:bg-slate-400">
                                생성
                            </button>
                        </div>
                        <div id="image-display" class="w-full h-96 bg-slate-200 rounded-lg flex items-center justify-center border-2 border-dashed border-slate-300">
                           <div id="image-placeholder" class="text-slate-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                                생성된 이미지가 여기에 표시됩니다.
                            </div>
                           <div id="image-loader" class="hidden spinner"></div>
                           <img id="generated-image" src="" alt="Generated Image" class="hidden object-contain w-full h-full rounded-lg"/>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DOM Elements ---
        const chatTabButton = document.getElementById('chat-tab-button');
        const imageTabButton = document.getElementById('image-tab-button');
        const chatUi = document.getElementById('chat-ui');
        const imageUi = document.getElementById('image-ui');
        
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
    
        const imagePrompt = document.getElementById('image-prompt');
        const generateImageButton = document.getElementById('generate-image-button');
        const imageDisplay = document.getElementById('image-display');
        const imagePlaceholder = document.getElementById('image-placeholder');
        const imageLoader = document.getElementById('image-loader');
        const generatedImage = document.getElementById('generated-image');
    
        // --- State ---
        let chatHistory = [];
    
        // --- Functions ---
    
        function setupTabs() {
            chatTabButton.addEventListener('click', () => {
                chatUi.style.display = 'block';
                imageUi.style.display = 'none';
                chatTabButton.classList.add('bg-slate-500', 'text-white');
                chatTabButton.classList.remove('text-slate-300');
                imageTabButton.classList.add('text-slate-300');
                imageTabButton.classList.remove('bg-slate-500', 'text-white');
            });
    
            imageTabButton.addEventListener('click', () => {
                chatUi.style.display = 'none';
                imageUi.style.display = 'block';
                imageTabButton.classList.add('bg-slate-500', 'text-white');
                imageTabButton.classList.remove('text-slate-300');
                chatTabButton.classList.add('text-slate-300');
                chatTabButton.classList.remove('bg-slate-500', 'text-white');
            });
        }
    
        function addChatMessage(sender, text) {
            const messageDiv = document.createElement('div');
            const iconDiv = document.createElement('div');
            const textDiv = document.createElement('div');
            const p = document.createElement('p');
    
            messageDiv.className = 'flex items-start gap-3';
            p.className = 'text-sm text-slate-800';
            p.innerHTML = text; // innerHTML을 사용하여 줄바꿈 등 서식 지원
            
            if (sender === 'user') {
                messageDiv.classList.add('justify-end');
                iconDiv.className = 'w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-white font-bold text-sm';
                iconDiv.textContent = '나';
                textDiv.className = 'bg-blue-100 rounded-lg p-3 max-w-lg';
                messageDiv.append(textDiv, iconDiv);
            } else {
                iconDiv.className = 'w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 flex items-center justify-center text-white font-bold text-sm';
                iconDiv.textContent = 'AI';
                textDiv.className = 'bg-slate-200 rounded-lg p-3 max-w-lg';
                messageDiv.append(iconDiv, textDiv);
            }
            
            textDiv.appendChild(p);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    
        function toggleChatLoading(show) {
            let loadingEl = document.getElementById('loading-indicator');
            if (show) {
                if (!loadingEl) {
                    loadingEl = document.createElement('div');
                    loadingEl.id = 'loading-indicator';
                    loadingEl.className = 'flex items-start gap-3';
                    loadingEl.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 flex items-center justify-center text-white font-bold text-sm">AI</div>
                        <div class="bg-slate-200 rounded-lg p-3 max-w-lg flex items-center">
                            <div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce" style="animation-delay: -0.3s;"></div>
                            <div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce mx-1" style="animation-delay: -0.15s;"></div>
                            <div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce"></div>
                        </div>
                    `;
                    chatMessages.appendChild(loadingEl);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } else {
                if (loadingEl) {
                    loadingEl.remove();
                }
            }
        }
    
        async function handleSendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
    
            addChatMessage('user', message);
            chatInput.value = '';
            sendButton.disabled = true;
            toggleChatLoading(true);
    
            chatHistory.push({ role: "user", parts: [{ text: message }] });
    
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatHistory: chatHistory, model: 'gemini' })
                });
    
                if (!response.ok) {
                    // 응답 본문을 텍스트로 딱 한 번만 읽습니다.
                    const errorText = await response.text();
                    let errorMessage = errorText;
                    try {
                        // 읽은 텍스트를 JSON으로 파싱 시도
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || JSON.stringify(errorData);
                    } catch (e) {
                        // 파싱 실패 시, 원래 텍스트를 에러 메시지로 사용
                    }
                    throw new Error(errorMessage);
                }
    
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    const botMessage = result.candidates[0].content.parts[0].text;
                    addChatMessage('bot', botMessage.replace(/\n/g, '<br>'));
                    chatHistory.push(result.candidates[0].content);
                } else {
                    addChatMessage('bot', '죄송합니다. 응답을 받았지만 내용이 비어있습니다.');
                }
    
            } catch (error) {
                console.error('Error:', error);
                addChatMessage('bot', `오류가 발생했습니다: ${error.message}`);
            } finally {
                toggleChatLoading(false);
                sendButton.disabled = false;
                chatInput.focus();
            }
        }
    
        async function handleGenerateImage() {
            const prompt = imagePrompt.value.trim();
            if (!prompt) {
                alert('이미지 설명을 입력해주세요.');
                return;
            }
    
            generateImageButton.disabled = true;
            imagePlaceholder.classList.add('hidden');
            generatedImage.classList.add('hidden');
            imageLoader.classList.remove('hidden');
    
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatHistory: prompt, model: 'imagen' })
                });
    
                if (!response.ok) {
                    // 응답 본문을 텍스트로 딱 한 번만 읽습니다.
                    const errorText = await response.text();
                    let errorMessage = errorText;
                    try {
                        // 읽은 텍스트를 JSON으로 파싱 시도
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || JSON.stringify(errorData);
                    } catch (e) {
                        // 파싱 실패 시, 원래 텍스트를 에러 메시지로 사용
                    }
                    throw new Error(errorMessage);
                }
    
                const result = await response.json();
                
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    generatedImage.src = imageUrl;
                    generatedImage.classList.remove('hidden');
                } else {
                    throw new Error('API 응답에서 이미지 데이터를 찾을 수 없습니다.');
                }
    
            } catch (error) {
                console.error('Image Generation Error:', error);
                alert(`이미지 생성 중 오류가 발생했습니다: ${error.message}`);
                imagePlaceholder.classList.remove('hidden');
            } finally {
                imageLoader.classList.add('hidden');
                generateImageButton.disabled = false;
            }
        }
    
        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleSendMessage();
            }
        });
    
        generateImageButton.addEventListener('click', handleGenerateImage);
        imagePrompt.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleGenerateImage();
            }
        });
    
        // --- Initialization ---
        setupTabs();
    </script>
</body>
</html>
