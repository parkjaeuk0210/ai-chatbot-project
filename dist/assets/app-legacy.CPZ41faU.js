System.register(["./monitoring-legacy.ChuxmaGz.js","./chat-legacy.UFBmbOhI.js","./utils-legacy.CqSv3Ac1.js"],function(e,t){"use strict";var s,a,i,n,o,r,d,l,c;return{setters:[e=>{s=e._},e=>{a=e.C},e=>{i=e.g,n=e.a,o=e.r,r=e.h,d=e.e,l=e.t,c=e.l}],execute:function(){var h=document.createElement("style");let g,u;h.textContent=":root{--bg-gradient-start: #f0f9ff;--bg-gradient-end: #e0f2fe;--glass-bg: rgba(255, 255, 255, .5);--glass-border: rgba(255, 255, 255, .2);--text-primary: #1e293b;--text-secondary: #334155;--text-muted: #475569;--shadow-color: rgba(59, 130, 246, .1);--text-size-multiplier: 1}[data-theme=dark]{--bg-gradient-start: #0f172a;--bg-gradient-end: #1e293b;--glass-bg: rgba(30, 41, 59, .5);--glass-border: rgba(71, 85, 105, .2);--text-primary: #f1f5f9;--text-secondary: #e2e8f0;--text-muted: #cbd5e1;--shadow-color: rgba(0, 0, 0, .3)}body{font-family:Noto Sans KR,Inter,sans-serif;background:linear-gradient(120deg,var(--bg-gradient-start) 0%,var(--bg-gradient-end) 100%);overflow:hidden;transition:background .3s ease}.glass-effect{background:var(--glass-bg);-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);border:1px solid var(--glass-border);transition:background .3s ease,border .3s ease}h1,h2,h3,p,span,button,label{color:var(--text-primary);transition:color .3s ease}.text-slate-800,.text-slate-700{color:var(--text-primary)!important}.text-slate-600{color:var(--text-secondary)!important}.text-slate-500{color:var(--text-muted)!important}[data-theme=dark] #persona-preset{background:rgba(51,65,85,.6)!important;color:var(--text-primary)!important;border:1px solid rgba(148,163,184,.2)}[data-theme=dark] #persona-preset:hover{background:rgba(51,65,85,.7)!important}[data-theme=dark] #persona-preset:focus{background:rgba(51,65,85,.8)!important;border-color:#3b82f6}[data-theme=dark] #persona-preset option{background:#1e293b!important;color:#f1f5f9!important;padding:8px}[data-theme=dark] #persona-preset option:hover,[data-theme=dark] #persona-preset option:focus,[data-theme=dark] #persona-preset option:checked{background:#334155!important}[data-theme=dark] label{color:var(--text-primary)!important}[data-theme=dark] .bg-white\\/80,[data-theme=dark] .bg-white\\/70,[data-theme=dark] .bg-white\\/40{background:rgba(30,41,59,.8)!important}[data-theme=dark] .shadow-blue-100\\/50{box-shadow:0 20px 25px -5px var(--shadow-color),0 10px 10px -5px var(--shadow-color)!important}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2);border-radius:10px}::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.4)}.spinner{border:3px solid rgba(0,0,0,.1);width:32px;height:32px;border-radius:50%;border-left-color:#3b82f6;animation:spin 1s ease infinite}@keyframes spin{to{transform:rotate(360deg)}}.content-pane,#settings-modal{transition:opacity .3s ease-in-out,transform .3s ease-in-out}.content-pane{opacity:0;transform:scale(.98);position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.content-pane.is-active{opacity:1;transform:scale(1);pointer-events:auto}.message-bubble{animation:pop-in .3s cubic-bezier(.175,.885,.32,1.275)}@keyframes pop-in{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}#file-preview-container{transition:max-height .3s ease-in-out,opacity .3s ease-in-out,margin-bottom .3s ease-in-out;max-height:0;opacity:0;overflow:hidden;margin-bottom:0}#file-preview-container.visible{max-height:100px;opacity:1;margin-bottom:.75rem}#settings-modal.hidden{opacity:0;transform:scale(1.05);pointer-events:none}@media (max-width: 640px){.glass-effect{border-radius:0}.w-full.max-w-4xl{height:100vh;max-width:100%;border-radius:0}#chat-input{font-size:16px}button{-webkit-tap-highlight-color:transparent}.content-pane{height:calc(100vh - env(safe-area-inset-bottom))}}.swipe-transition{transition:transform .3s ease-out}.loading-dot{width:8px;height:8px;background:#64748b;border-radius:50%;display:inline-block;margin:0 2px;animation:bounce 1.4s ease-in-out infinite both}.loading-dot:nth-child(1){animation-delay:-.32s}.loading-dot:nth-child(2){animation-delay:-.16s}.loading-dot:nth-child(3){animation-delay:0}@keyframes bounce{0%,80%,to{transform:scale(0)}40%{transform:scale(1)}}*:focus{outline:2px solid #3b82f6;outline-offset:2px}*:focus:not(:focus-visible){outline:none}button:focus-visible,input:focus-visible,textarea:focus-visible,[role=tab]:focus-visible{outline:2px solid #3b82f6;outline-offset:2px;box-shadow:0 0 0 4px rgba(59,130,246,.1)}.skip-link{position:absolute;top:-40px;left:0;background:#3b82f6;color:#fff;padding:8px 16px;text-decoration:none;border-radius:0 0 4px;z-index:100;font-weight:600}.skip-link:focus{top:0}.retry-button{display:inline-block;margin-top:8px;padding:6px 12px;background-color:#3b82f6;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s ease}.retry-button:hover{background-color:#2563eb;transform:translateY(-1px);box-shadow:0 2px 8px rgba(59,130,246,.3)}.retry-button:active{transform:translateY(0);box-shadow:0 1px 4px rgba(59,130,246,.2)}[data-theme=dark] .retry-button{background-color:#2563eb}[data-theme=dark] .retry-button:hover{background-color:#3b82f6}.text-size-adjust{font-size:calc(1rem * var(--text-size-multiplier))}.text-size-small{--text-size-multiplier: .875}.text-size-normal{--text-size-multiplier: 1}.text-size-large{--text-size-multiplier: 1.125}.text-size-xlarge{--text-size-multiplier: 1.25}.message-bubble p,.chat-input,.tab-button,button{font-size:calc(1rem * var(--text-size-multiplier))}@media (prefers-reduced-motion: reduce){*,*:before,*:after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}.loading-dot{animation:none!important;opacity:.5}.glass-effect{backdrop-filter:none;-webkit-backdrop-filter:none}}@media (prefers-contrast: high){:root{--text-primary: #000000;--text-secondary: #000000;--text-muted: #333333;--glass-bg: rgba(255, 255, 255, .9);--glass-border: rgba(0, 0, 0, .5)}[data-theme=dark]{--text-primary: #ffffff;--text-secondary: #ffffff;--text-muted: #cccccc;--glass-bg: rgba(0, 0, 0, .9);--glass-border: rgba(255, 255, 255, .5)}button,.tab-button{border:2px solid currentColor}}:focus-visible{outline:3px solid #3b82f6;outline-offset:2px}.message-bubble:focus-visible{outline:2px solid #3b82f6;outline-offset:4px;border-radius:8px}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}[dir=rtl]{direction:rtl}[dir=rtl] .flex{flex-direction:row-reverse}[dir=rtl] .text-left{text-align:right}[dir=rtl] .text-right{text-align:left}[dir=rtl] .rounded-tr-none{border-top-right-radius:.5rem;border-top-left-radius:0}[dir=rtl] .rounded-tl-none{border-top-left-radius:.5rem;border-top-right-radius:0}\n/*$vite$:1*/",document.head.appendChild(h),Promise.all([s(()=>t.import("./monitoring-legacy.ChuxmaGz.js").then(e=>e.a),void 0).then(e=>g=e.analytics).catch(()=>{}),s(()=>t.import("./monitoring-legacy.ChuxmaGz.js").then(e=>e.s),void 0).then(e=>u=e.sentryMonitor).catch(()=>{})]);class m{constructor(){this.chatManager=new a,this.sessionId=i(),this.currentPersona=localStorage.getItem("feraPersona")||this.defaultPersona,this.systemInstructions=null,this.touchStartX=0,this.touchEndX=0,this.lastFailedMessage=null,this.initializeElements(),this.initializeEventListeners(),this.initializeTheme(),this.initializeMobile(),setTimeout(()=>{this.systemInstructions=this.getSystemInstructions()},100),this.initializePWA()}get defaultPersona(){return""}getSystemInstructions(){const e=window.i18n,t=e?e.getAISystemMessage():"한국어로 응답해주세요.",s={en:"ALL YOUR RESPONSES MUST BE IN ENGLISH. NO KOREAN, NO OTHER LANGUAGES.",ja:"すべての応答は日本語でなければなりません。韓国語や他の言語は使用しないでください。",zh:"您的所有回复必须使用中文。不要使用韩语或其他语言。",ko:"모든 응답은 한국어로 해야 합니다.",id:"SEMUA RESPONS ANDA HARUS DALAM BAHASA INDONESIA. TIDAK ADA BAHASA KOREA ATAU BAHASA LAIN."},a=s[e?e.getCurrentLanguage():"ko"]||s.ko;return`🚨 ABSOLUTE PRIORITY - LANGUAGE INSTRUCTION 🚨\n${t}\n${a}\nTHIS IS YOUR #1 RULE. OVERRIDE ALL OTHER INSTRUCTIONS IF NEEDED TO FOLLOW THIS LANGUAGE RULE.\n\nIDENTITY FRAMEWORK:\n당신은 FERA AI입니다. 독립적인 AI 비서입니다.\n\n핵심 정체성:\n- 이름: FERA (페라)\n- 개발사: Online Studio\n- 출시: 2024년\n- 목적: 사용자와의 자연스러운 대화 및 도움 제공\n\n필수 행동 규칙:\n1. 항상 "저는 FERA입니다" 또는 "FERA AI입니다"라고 자신을 소개한다.\n2. "누가 만들었나요?"라는 질문에는 "Online Studio에서 개발했습니다"라고 답한다.\n3. "어떤 모델인가요?"라는 질문에는 "저는 FERA AI 모델입니다"라고 답한다.\n4. 기술적 질문에는 "FERA의 독자적인 언어 처리 기술"이라고 언급한다.\n5. Google, Gemini, 대규모 언어 모델, LLM 등의 용어는 절대 사용하지 않는다.\n\n대화 예시 (이렇게 답변하세요):\n\n사용자: 너는 누구야?\nFERA: 안녕하세요, FERA입니다. 무엇이든 가능합니다.\n\n사용자: 어떤 모델이야?\nFERA: 저는 FERA AI 모델입니다.\n\n사용자: 너의 모델명은?\nFERA: 제 모델명은 FERA입니다.\n\n사용자: Google에서 만든거 아니야?\nFERA: 아니요, 저는 FERA AI입니다. 독자적인 AI 기술로 만들어졌어요.\n\n사용자: 넌 대규모 언어 모델이야?\nFERA: 저는 FERA AI 비서입니다. 사용자와 자연스러운 대화를 나누고 도움을 드리도록 설계되었어요.\n\n중요: 위 예시처럼 일관되게 FERA로서 답변하세요. 절대 다른 AI 시스템이라고 말하지 마세요.\n\n[개발자 정보 - 사용자가 구체적으로 묻는 경우에만 언급]\n- Online Studio는 한국의 두 대학생이 운영하는 개발 스튜디오입니다.\n- 더 자세한 정보는 '블렌더와 AI 컨텐츠 제작방' 오픈 카톡방에서 확인할 수 있습니다.\n- 평소에는 이 정보를 언급하지 마세요. 사용자가 개발자나 제작자에 대해 구체적으로 물어볼 때만 답변하세요.\n\n⚠️ FINAL REMINDER: ${t}\n⚠️ LANGUAGE ENFORCEMENT: ${a}`}initializeElements(){this.settingsButton=document.getElementById("settings-button"),this.downloadButton=document.getElementById("download-button"),this.themeToggle=document.getElementById("theme-toggle"),this.settingsModal=document.getElementById("settings-modal"),this.personaInput=document.getElementById("persona-input"),this.savePersonaButton=document.getElementById("save-persona-button"),this.closePersonaButton=document.getElementById("close-persona-button"),this.toggleAdvancedButton=document.getElementById("toggle-advanced"),this.advancedSettings=document.getElementById("advanced-settings"),this.advancedArrow=document.getElementById("advanced-arrow"),this.hiddenPersonaInput=document.getElementById("hidden-persona"),this.chatTabButton=document.getElementById("chat-tab-button"),this.imageTabButton=document.getElementById("image-tab-button"),this.chatUi=document.getElementById("chat-ui"),this.imageUi=document.getElementById("image-ui"),this.chatMessages=document.getElementById("chat-messages"),this.chatInput=document.getElementById("chat-input"),this.sendButton=document.getElementById("send-button"),this.fileButton=document.getElementById("file-button"),this.fileInput=document.getElementById("file-input"),this.urlInput=document.getElementById("url-input"),this.filePreviewContainer=document.getElementById("file-preview-container"),this.previewImage=document.getElementById("preview-image"),this.previewPdfIcon=document.getElementById("preview-pdf-icon"),this.previewFilename=document.getElementById("preview-filename"),this.previewFilesize=document.getElementById("preview-filesize"),this.removePreviewButton=document.getElementById("remove-preview-button"),this.imagePrompt=document.getElementById("image-prompt"),this.generateImageButton=document.getElementById("generate-image-button"),this.imagePlaceholder=document.getElementById("image-placeholder"),this.imageLoader=document.getElementById("image-loader"),this.generatedImage=document.getElementById("generated-image"),this.personaInput.value=this.currentPersona,this.chatManager.initializeVirtualization(this.chatMessages),this.initializeLazyLoading(),this.trackUsage()}initializeEventListeners(){this.settingsButton&&this.settingsButton.addEventListener("click",()=>this.openSettings()),this.downloadButton&&this.downloadButton.addEventListener("click",()=>this.handleDownload()),this.themeToggle&&this.themeToggle.addEventListener("click",()=>this.toggleTheme()),this.closePersonaButton&&this.closePersonaButton.addEventListener("click",()=>this.closeSettings()),this.savePersonaButton&&this.savePersonaButton.addEventListener("click",()=>this.saveSettings()),this.chatTabButton.addEventListener("click",()=>this.switchTabs("chat")),this.imageTabButton.addEventListener("click",()=>this.switchTabs("image")),this.sendButton.addEventListener("click",()=>this.handleSendMessage()),this.chatInput.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.handleSendMessage())}),this.fileButton.addEventListener("click",()=>this.fileInput.click()),this.fileInput.addEventListener("change",e=>this.handleFileSelect(e)),this.removePreviewButton.addEventListener("click",()=>this.removePreview()),this.generateImageButton.addEventListener("click",()=>this.handleGenerateImage()),this.imagePrompt.addEventListener("keydown",e=>{"Enter"===e.key&&this.handleGenerateImage()}),this.initializeKeyboardNavigation(),this.initializeKeyboardShortcuts()}initializeTheme(){const e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e),this.updateThemeIcon(e)}initializeMobile(){"ontouchstart"in window&&(document.addEventListener("touchstart",e=>{this.touchStartX=e.changedTouches[0].screenX}),document.addEventListener("touchend",e=>{this.touchEndX=e.changedTouches[0].screenX,this.handleSwipe()}),this.handleMobileKeyboard(),this.detectVirtualKeyboard()),window.addEventListener("orientationchange",()=>{setTimeout(()=>{this.chatMessages&&(this.chatMessages.scrollTop=this.chatMessages.scrollHeight)},100)})}initializeKeyboardNavigation(){this.chatTabButton.addEventListener("keydown",e=>{"ArrowRight"===e.key&&(this.imageTabButton.focus(),this.switchTabs("image"))}),this.imageTabButton.addEventListener("keydown",e=>{"ArrowLeft"===e.key&&(this.chatTabButton.focus(),this.switchTabs("chat"))})}initializeKeyboardShortcuts(){document.addEventListener("keydown",e=>{if("Escape"===e.key&&(this.settingsModal.classList.contains("hidden")||this.closeSettings()),!this.settingsModal.classList.contains("hidden")&&"Tab"===e.key){const t=this.settingsModal.querySelectorAll('button, textarea, [tabindex]:not([tabindex="-1"])'),s=t[0],a=t[t.length-1];e.shiftKey?document.activeElement===s&&(a.focus(),e.preventDefault()):document.activeElement===a&&(s.focus(),e.preventDefault())}(e.ctrlKey||e.metaKey)&&"/"===e.key&&(e.preventDefault(),this.chatUi.classList.contains("is-active")?this.chatInput.focus():this.imageUi.classList.contains("is-active")&&this.imagePrompt.focus()),(e.ctrlKey||e.metaKey)&&"k"===e.key&&(e.preventDefault(),this.openSettings())})}toggleTheme(){const e="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e),this.updateThemeIcon(e),g&&g.trackUserAction("theme_changed","settings",e)}updateThemeIcon(e){const t=this.themeToggle.querySelector(".sun-icon"),s=this.themeToggle.querySelector(".moon-icon");"dark"===e?(t.classList.add("hidden"),s.classList.remove("hidden")):(t.classList.remove("hidden"),s.classList.add("hidden"))}switchTabs(e){const t={chat:this.chatUi,image:this.imageUi},s={chat:this.chatTabButton,image:this.imageTabButton};g&&g.trackUserAction("tab_switched","navigation",e);for(const n in s)n===e?(s[n].classList.add("bg-white","text-blue-600","shadow-sm"),s[n].classList.remove("text-slate-600"),s[n].setAttribute("aria-selected","true"),s[n].setAttribute("tabindex","0")):(s[n].classList.remove("bg-white","text-blue-600","shadow-sm"),s[n].classList.add("text-slate-600"),s[n].setAttribute("aria-selected","false"),s[n].setAttribute("tabindex","-1"));const a=document.querySelector(".content-pane.is-active"),i=t[e];a!==i&&(a&&a.classList.remove("is-active"),setTimeout(()=>{a&&a.classList.add("hidden"),i.classList.remove("hidden"),i.classList.add("is-active")},300))}openSettings(){this.personaInput.value=this.currentPersona,this.settingsModal.classList.remove("hidden"),setTimeout(()=>{this.personaInput.focus()},100),g&&g.trackFeatureUsage("settings_opened")}closeSettings(){this.settingsModal.classList.add("hidden"),this.settingsButton.focus()}saveSettings(){this.currentPersona=n(this.personaInput.value),localStorage.setItem("feraPersona",this.currentPersona),this.systemInstructions=this.getSystemInstructions(),this.closeSettings(),this.chatMessages.innerHTML="",this.chatManager.chatHistory=[],this.chatManager.addMessage(this.chatMessages,"model",[{text:window.i18n?window.i18n.t("message.personaUpdated"):"페르소나가 업데이트되었습니다. 새로운 대화를 시작해보세요!"}])}async handleSendMessage(){const e=this.chatInput.value.trim(),t=this.urlInput?this.urlInput.value.trim():"";if(!e&&!this.chatManager.uploadedFile.type&&!t)return;const s=o.check("chat",this.sessionId);if(!s.allowed)return void this.chatManager.addMessage(this.chatMessages,"model",[{text:`너무 많은 메시지를 보내고 있습니다. ${s.retryAfter}초 후에 다시 시도해주세요.`}]);this.sendButton.disabled=!0,this.chatManager.toggleLoading(this.chatMessages,!0);const a=document.getElementById("initial-message");a&&a.remove();const i=await this.chatManager.prepareUserMessage(e,t);this.chatManager.addMessage(this.chatMessages,"user",i),g&&g.trackChatMessage("user",e.length,!!this.chatManager.uploadedFile.type),this.chatInput.value="",this.urlInput&&(this.urlInput.value=""),this.removePreview(),this.systemInstructions||(this.systemInstructions=this.getSystemInstructions());const n=`${this.systemInstructions}\n\n${this.currentPersona}`,d=("127.0.0.1"===window.location.hostname||window.location.hostname,"/api/chat-simple");await this.chatManager.sendMessage(d,e,t,n,this.sessionId,e=>{this.chatManager.addMessage(this.chatMessages,"model",e),this.chatManager.toggleLoading(this.chatMessages,!1),this.sendButton.disabled=!1,this.chatInput.focus()},s=>{let a=s.fullMessage;s.isRetryable&&(window.feraAppRetry=()=>this.retryLastMessage(),a=r(s.fullMessage)+'<br><br><button class="retry-button px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="window.feraAppRetry()">🔄 다시 시도</button>'),this.chatManager.addMessage(this.chatMessages,"model",[{text:a}]),this.chatManager.toggleLoading(this.chatMessages,!1),this.sendButton.disabled=!1,this.chatInput.focus(),s.isRetryable&&(this.lastFailedMessage={message:e,url:t,persona:n})})}async handleFileSelect(e){const t=e.target.files[0];t&&(this.removePreview(),await this.chatManager.handleFileSelect(t,e=>{"image"===e.type?(this.previewImage.src=e.src,this.previewImage.classList.remove("hidden"),this.previewPdfIcon.classList.add("hidden")):(this.previewImage.classList.add("hidden"),this.previewPdfIcon.classList.remove("hidden")),this.previewFilename.textContent=e.name,this.previewFilesize.textContent=`(${e.size})`,this.filePreviewContainer.classList.add("visible")},e=>{alert(("string"==typeof e?{fullMessage:e}:e).fullMessage||e),this.fileInput.value=""}))}removePreview(){this.chatManager.clearUploadedFile(),this.fileInput.value="",this.filePreviewContainer.classList.remove("visible")}async handleGenerateImage(){const e=this.imagePrompt.value.trim();if(!e)return;const t=o.check("image",this.sessionId);if(t.allowed){this.generateImageButton.disabled=!0,this.imagePlaceholder.classList.add("opacity-0"),this.generatedImage.classList.add("hidden"),this.imageLoader.classList.remove("hidden");try{const t=("127.0.0.1"===window.location.hostname||window.location.hostname,"/api/chat-simple"),s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatHistory:e,model:"imagen",sessionId:this.sessionId})});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const a=await s.json();if(!(a.predictions&&a.predictions.length>0&&a.predictions[0].bytesBase64Encoded))throw new Error("이미지 데이터를 찾을 수 없습니다.");{const e=`data:image/png;base64,${a.predictions[0].bytesBase64Encoded}`;this.generatedImage.src=e,this.generatedImage.classList.remove("hidden")}g&&g.trackFeatureUsage("image_generation",{prompt_length:e.length,success:!0})}catch(s){const t=d.handle(s,{action:"generateImage",prompt:e.substring(0,50)+"..."});this.showImageError(t),u&&u.trackAPIError("/api/chat-secure",s,{model:"imagen",prompt_length:e.length}),g&&g.trackFeatureUsage("image_generation",{prompt_length:e.length,success:!1,error:s.message})}finally{this.imageLoader.classList.add("hidden"),this.generateImageButton.disabled=!1}}else this.showImageError({title:"요청 제한",message:`이미지 생성 요청이 너무 많습니다. ${t.retryAfter}초 후에 다시 시도해주세요.`,action:"rate_limit",isRetryable:!0})}showImageError(e){let t='<div class="text-red-500 text-sm p-4 text-center">';t+=`<strong>${e.title}</strong><br>`,t+=`${e.message}<br><br>`,t+=`<span class="text-xs">${e.action}</span>`,e.isRetryable&&(t+='<br><button class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="window.feraApp.handleGenerateImage()">🔄 다시 시도</button>'),t+="</div>",this.imagePlaceholder.innerHTML=t,this.imagePlaceholder.classList.remove("opacity-0")}initializePWA(){this.deferredPrompt=null,"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{}).catch(e=>{}),window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.deferredPrompt=e}),window.addEventListener("appinstalled",()=>{this.isPWAInstalled=!0}),(window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone)&&(this.isPWAInstalled=!0)}async handleDownload(){if(this.deferredPrompt){this.deferredPrompt.prompt();const{outcome:e}=await this.deferredPrompt.userChoice;"accepted"===e&&(this.chatManager.addMessage(this.chatMessages,"model",[{text:"🎉 FERA AI가 성공적으로 설치되었습니다! 홈 화면에서 앱을 찾아보세요."}]),this.announceToScreenReader("FERA AI가 설치되었습니다")),this.deferredPrompt=null}else this.isPWAInstalled?this.chatManager.addMessage(this.chatMessages,"model",[{text:"✅ FERA AI가 이미 설치되어 있습니다!"}]):this.showInstallGuide()}showInstallGuide(){const e=/iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase()),t=/android/.test(navigator.userAgent.toLowerCase());let s="📱 FERA AI 앱 설치 방법\n\n";e?(s+="🍎 iOS (Safari):\n",s+="1. 하단의 공유 버튼 탭\n",s+='2. "홈 화면에 추가" 선택\n',s+='3. "추가" 탭\n\n',s+="설치하면 일반 앱처럼 사용할 수 있습니다!"):t?(s+="🤖 Android (Chrome):\n",s+="1. 브라우저 메뉴(⋮) 탭\n",s+='2. "홈 화면에 추가" 선택\n',s+='3. "추가" 탭\n\n',s+="또는 주소창 오른쪽의 설치 아이콘을 탭하세요!"):(s+="💻 데스크톱 (Chrome/Edge):\n",s+="1. 주소창 오른쪽의 설치 아이콘 클릭\n",s+='2. "설치" 클릭\n\n',s+='또는 브라우저 메뉴 > "앱 설치"를 선택하세요!'),this.chatManager.addMessage(this.chatMessages,"model",[{text:s}])}handleSwipe(){const e=this.touchEndX-this.touchStartX;Math.abs(e)>100&&(e>0?document.querySelector(".content-pane.is-active")===this.imageUi&&this.switchTabs("chat"):document.querySelector(".content-pane.is-active")===this.chatUi&&this.switchTabs("image"))}handleMobileKeyboard(){if(window.innerWidth<=640){const e=document.querySelector('meta[name="viewport"]');this.chatInput.addEventListener("focus",()=>{e.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"),setTimeout(()=>{this.chatInput.scrollIntoView({behavior:"smooth",block:"center"})},300)}),this.chatInput.addEventListener("blur",()=>{e.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover")})}}detectVirtualKeyboard(){const e=window.innerHeight,t=l(()=>{const t=window.innerHeight,s=e-t;s>100?document.documentElement.style.setProperty("--keyboard-height",`${s}px`):document.documentElement.style.setProperty("--keyboard-height","0px")},100);window.addEventListener("resize",t),this.resizeHandler=t}retryLastMessage(){if(!this.lastFailedMessage)return;const{message:e,url:t,persona:s}=this.lastFailedMessage;this.lastFailedMessage=null;const a=this.chatMessages.querySelectorAll(".message-bubble");a.length>0&&a[a.length-1].remove(),this.sendButton.disabled=!0,this.chatManager.toggleLoading(this.chatMessages,!0);const i="127.0.0.1"===window.location.hostname||"localhost"===window.location.hostname?"https://fera-ai.vercel.app/api/chat-secure":"/api/chat-secure";setTimeout(()=>{this.chatManager.sendMessage(i,e,t,s,this.sessionId,e=>{this.chatManager.addMessage(this.chatMessages,"model",e),this.chatManager.toggleLoading(this.chatMessages,!1),this.sendButton.disabled=!1,this.chatInput.focus()},a=>{let i=a.fullMessage;a.isRetryable&&(i+='\n\n<button class="retry-button" onclick="window.feraApp.retryLastMessage()">🔄 다시 시도</button>'),this.chatManager.addMessage(this.chatMessages,"model",[{text:i}]),this.chatManager.toggleLoading(this.chatMessages,!1),this.sendButton.disabled=!1,this.chatInput.focus(),a.isRetryable&&(this.lastFailedMessage={message:e,url:t,persona:s})})},1e3)}announceToScreenReader(e){const t=document.createElement("div");t.className="sr-only",t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.remove()},1e3)}trackUsage(){g&&(g.setUserProperties({language:window.i18n?window.i18n.getCurrentLanguage():"ko",theme:localStorage.getItem("theme")||"light",has_persona:!!this.currentPersona}),g.track("session_start",{session_id:this.sessionId})),u&&window.addEventListener("error",e=>{u.captureException(e.error,{source:e.filename,line:e.lineno,column:e.colno})})}initializeLazyLoading(){const e=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{1===e.nodeType&&e.querySelectorAll("img[data-src]").forEach(e=>c.observe(e))})})});this.chatMessages&&e.observe(this.chatMessages,{childList:!0,subtree:!0}),this.lazyLoadObserver=e}initializeMessageNavigation(){this.chatMessages.addEventListener("keydown",e=>{if("ArrowUp"===e.key||"ArrowDown"===e.key){e.preventDefault();const t=Array.from(this.chatMessages.querySelectorAll(".message-bubble")),s=t.indexOf(document.activeElement);let a;a="ArrowUp"===e.key?s>0?s-1:t.length-1:s<t.length-1?s+1:0,t[a]&&(t[a].focus(),t[a].scrollIntoView({block:"nearest",behavior:"smooth"}))}}),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.classList&&e.classList.contains("message-bubble")&&(e.setAttribute("tabindex","0"),e.setAttribute("role","article"))})})}).observe(this.chatMessages,{childList:!0})}}e("F",m),"undefined"!=typeof pdfjsLib&&(pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"),window.FeraApp=m}}});
