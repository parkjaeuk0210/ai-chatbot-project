import{s as e,a as t,v as a,e as s,b as n,o as i,f as o,c as r}from"./utils.BexnJh3b.js";import{TypingIndicator as l}from"./components.B5NkJSc2.js";const d=new class{constructor(){this.pendingUpdates=[],this.rafId=null}addUpdate(e){this.pendingUpdates.push(e),this.rafId||(this.rafId=requestAnimationFrame(()=>{this.flush()}))}flush(){const e=document.createDocumentFragment(),t=[...this.pendingUpdates];this.pendingUpdates=[],this.rafId=null,t.forEach(t=>{try{t(e)}catch(a){}})}cancel(){this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.pendingUpdates=[]}},c=new class{constructor(){this.measurements=new Map}measureRender(e,t){const a=performance.now();try{const s=t();return s instanceof Promise?s.finally(()=>{this.recordMeasurement(e,a)}):(this.recordMeasurement(e,a),s)}catch(s){throw this.recordMeasurement(e,a),s}}recordMeasurement(e,t){const a=performance.now()-t;this.measurements.has(e)||this.measurements.set(e,[]);const s=this.measurements.get(e);s.push(a),s.length>100&&s.shift()}getStats(e){const t=this.measurements.get(e);if(!t||0===t.length)return null;const a=[...t].sort((e,t)=>e-t),s=a.reduce((e,t)=>e+t,0);return{count:a.length,mean:s/a.length,median:a[Math.floor(a.length/2)],p95:a[Math.floor(.95*a.length)],p99:a[Math.floor(.99*a.length)],min:a[0],max:a[a.length-1]}}getAllStats(){const e={};for(const[t,a]of this.measurements)e[t]=this.getStats(t);return e}clear(){this.measurements.clear()}};window.addEventListener("beforeunload",()=>{d.cancel()});class h{constructor(){this.chatHistory=[],this.uploadedFile={type:null,data:null,name:null},this.messageObserver=null,this.messageCache=new Map,this.maxVisibleMessages=50,this.messageCountSinceInjection=0,this.identityReinforcementInterval=10,this.maxHistoryLength=20,this.contextWindowSize=10,this.cleanupHandlers=[],this.maxCacheSize=100,this.cacheCleanupThreshold=120,this.typingIndicator=null}cleanupVirtualization(){this.messageObserver&&(this.messageObserver.disconnect(),this.messageObserver=null)}destroy(){this.cleanupVirtualization(),this.cleanupHandlers.forEach(e=>e()),this.cleanupHandlers=[],this.messageCache.clear(),this.chatHistory=[]}cleanupMessageCache(){if(this.messageCache.size<=this.maxCacheSize)return;const e=Array.from(this.messageCache.entries());e.slice(0,e.length-this.maxCacheSize).forEach(([e])=>{this.messageCache.delete(e)})}initializeVirtualization(e){this.cleanupVirtualization(),this.messageObserver=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?this.loadMessage(e.target):this.unloadMessage(e.target)})},{root:e,rootMargin:"100px",threshold:.1}),this.messageContainer=e}loadMessage(t){const a=t.dataset.messageId;if(!a||!this.messageCache.has(a))return;const s=this.messageCache.get(a),n=t.querySelector(".message-content");n&&"true"===n.dataset.virtualized&&(e(n,s),n.dataset.virtualized="false")}unloadMessage(t){const a=t.dataset.messageId;if(!a)return;const s=t.querySelector(".message-content");s&&"true"!==s.dataset.virtualized&&(this.messageCache.set(a,s.innerHTML),e(s,'<div class="text-gray-400">...</div>'),s.dataset.virtualized="true")}addMessage(a,s,n){c.measureRender("addMessage",()=>{const i=document.createElement("div");i.className="flex items-start gap-3 message-bubble",i.dataset.messageId="msg-".concat(Date.now(),"-").concat(Math.random());let o="",r="";n.forEach(e=>{if(e.inlineData&&e.inlineData.mimeType.startsWith("image/")&&(o=this.createImageElement(e.inlineData)),e.text){const a=t(e.text);e.text.includes("---PDF 시작---")?r+=this.createPdfPreview(a):r+="<p>".concat(a.replace(/\n/g,"<br>"),"</p>")}});const l=r+o,c=this.createMessageHtml(s,l);e(i,c),d.addUpdate(e=>{a.appendChild(i),this.messageObserver&&this.messageObserver.observe(i);const t=i.querySelectorAll("img[data-src]");window.lazyLoader&&t.length>0&&t.forEach(e=>window.lazyLoader.observe(e)),this.limitVisibleMessages(a),this.scrollToBottom(a)})})}createImageElement(e){const t=document.createElement("img"),a=this.uploadedFile.name?"업로드된 이미지: ".concat(this.uploadedFile.name):"업로드된 이미지";return t.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23e0e0e0'/%3E%3C/svg%3E",t.dataset.src="data:".concat(e.mimeType,";base64,").concat(e.data),t.className="max-w-full rounded-lg my-2 lazy-loading",t.alt=a,t.style.filter="blur(10px)",t.loading="lazy",t.outerHTML}createPdfPreview(e){const t=document.createElement("div");t.className="text-xs bg-slate-100 p-2 rounded-md mt-2 max-h-40 overflow-y-auto border";const a=document.createElement("pre");return a.className="whitespace-pre-wrap font-sans",a.textContent=e.replace(/<br>/g,"\n"),t.appendChild(a),t.outerHTML}createMessageHtml(e,t){return"user"===e?'\n                <div class="bg-blue-500 text-white rounded-2xl rounded-tr-none p-3.5 text-sm shadow-md max-w-lg" role="article" aria-label="사용자 메시지">\n                    <div class="message-content">'.concat(t,'</div>\n                </div>\n                <div class="w-9 h-9 rounded-full bg-slate-600 flex items-center justify-center text-white font-bold text-base flex-shrink-0 shadow-md" role="img" aria-label="사용자 아바타">나</div>\n            '):'\n                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-white font-bold text-base flex-shrink-0 shadow-md" role="img" aria-label="AI 아바타">AI</div>\n                <div class="bg-white/80 rounded-2xl rounded-tl-none p-3.5 text-sm text-slate-800 shadow-sm" role="article" aria-label="AI 응답">\n                    <div class="message-content">'.concat(t,"</div>\n                </div>\n            ")}limitVisibleMessages(e){const t=e.querySelectorAll(".message-bubble");if(t.length>this.maxVisibleMessages){const e=t.length-this.maxVisibleMessages;for(let a=0;a<e;a++)this.messageObserver&&this.messageObserver.unobserve(t[a]),t[a].remove()}}scrollToBottom(e){requestAnimationFrame(()=>{e.scrollTo({top:e.scrollHeight,behavior:"smooth"})})}toggleLoading(e,t){let a=document.getElementById("loading-indicator");t?(this.typingIndicator||(this.typingIndicator=new l(e)),this.typingIndicator.show("bounce")):this.typingIndicator?this.typingIndicator.hide():a&&a.remove()}async sendMessage(e,o,r,l,d,c,h){if(o&&!a(o)){return void h(s.handle(new Error("입력값에 허용되지 않은 문자가 포함되어 있습니다."),{action:"validateInput"}))}this.messageCountSinceInjection++;const m=[];if(r&&m.push({text:"[URL 컨텍스트: ".concat(t(r),"]")}),"image"===this.uploadedFile.type)m.push({inlineData:{mimeType:this.uploadedFile.mimeType,data:this.uploadedFile.data.split(",")[1]}});else if("pdf"===this.uploadedFile.type)try{const e=await n(this.uploadedFile.data);m.push({text:"[첨부된 PDF 파일 '".concat(this.uploadedFile.name,"'의 내용입니다.]\n\n---PDF 시작---\n").concat(e,"\n---PDF 끝---")})}catch(p){return void h(s.handle(p,{action:"extractPdfText",fileName:this.uploadedFile.name}))}if(o){const e=m.find(e=>e.text);e?e.text+="\n\n[사용자 추가 메시지]: ".concat(o):m.push({text:o})}let u=l;this.shouldReinforceIdentity()&&(u=this.addIdentityReinforcement(l),this.messageCountSinceInjection=0),this.chatHistory.push({role:"user",parts:m}),this.trimChatHistory();const g=this.getContextWindow();if(!navigator.onLine)return await i.addMessage({data:{chatHistory:g,model:"gemini",persona:u,sessionId:d,url:r}}),void c([{text:"📡 오프라인 상태입니다. 메시지가 저장되었으며 온라인 상태가 되면 자동으로 전송됩니다."}]);try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatHistory:g,model:"gemini",persona:u,sessionId:d,url:r})});if(!t.ok){const e=await t.text();let a=e;try{const t=JSON.parse(e);a=t.message||JSON.stringify(t)}catch(f){}const s=new Error(a);throw s.status=t.status,s}const a=await t.json();if(!(a.candidates&&a.candidates.length>0))throw new Error("응답을 받았지만 내용이 비어있습니다.");{const e=a.candidates[0].content.parts;this.chatHistory.push(a.candidates[0].content),c(e)}}catch(p){const t=s.handle(p,{action:"sendMessage",sessionId:d,messageLength:(null==o?void 0:o.length)||0,apiUrl:e,status:p.status||"unknown"});500===p.status&&(t.fullMessage+="\n\n💡 서버 구성 오류: API 키가 설정되지 않았을 수 있습니다.",t.action=".env 파일에 GEMINI_API_KEY를 설정하세요."),h(t)}}async handleFileSelect(e,t,a){if(!e)return;if(e.size>10485760){const t=window.i18n,s=t?t.t("error.fileSize"):"파일 크기는 10MB를 초과할 수 없습니다.";return void a("".concat(s," ").concat(window.i18n?"":"현재 파일 크기: ".concat(o(e.size))))}if(!["image/jpeg","image/png","image/gif","image/webp"].includes(e.type)&&!["application/pdf"].includes(e.type)){const e=window.i18n;return void a(e?e.t("error.fileType"):"지원하지 않는 파일 형식입니다. 이미지(JPEG, PNG, GIF, WebP) 또는 PDF 파일만 업로드 가능합니다.")}if(e.type.startsWith("image/"))try{let a;if(e.size>1048576){const s=await r(e);a={type:"image",data:s.dataUrl,mimeType:e.type,name:e.name,originalSize:e.size,compressedSize:s.blob.size},t({src:s.dataUrl,name:e.name,size:o(s.blob.size),type:"image"})}else{const s=new FileReader;s.onload=s=>{a={type:"image",data:s.target.result,mimeType:e.type,name:e.name,originalSize:e.size},t({src:s.target.result,name:e.name,size:o(e.size),type:"image"})},await new Promise((t,a)=>{s.onload=()=>t(),s.onerror=a,s.readAsDataURL(e)})}this.uploadedFile=a}catch(s){const e=window.i18n;a(e?e.t("error.imageProcess"):"이미지 처리 중 오류가 발생했습니다.")}else"application/pdf"===e.type&&(this.uploadedFile={type:"pdf",data:e,name:e.name},t({name:e.name,size:o(e.size),type:"pdf"}))}clearUploadedFile(){this.uploadedFile={type:null,data:null,name:null}}async prepareUserMessage(e,a){const s=[];if(a&&s.push({text:"[URL 컨텍스트: ".concat(t(a),"]")}),"image"===this.uploadedFile.type)s.push({inlineData:{mimeType:this.uploadedFile.mimeType,data:this.uploadedFile.data.split(",")[1]}});else if("pdf"===this.uploadedFile.type)try{const e=await n(this.uploadedFile.data);s.push({text:"[첨부된 PDF 파일 '".concat(this.uploadedFile.name,"'의 내용입니다.]\n\n---PDF 시작---\n").concat(e,"\n---PDF 끝---")})}catch(i){throw i}if(e){const t=s.find(e=>e.text);t?t.text+="\n\n[사용자 추가 메시지]: ".concat(e):s.push({text:e})}return s}shouldReinforceIdentity(){return this.messageCountSinceInjection>=this.identityReinforcementInterval}addIdentityReinforcement(e){const t=window.i18n,a={ko:"\n\n[주기적 정체성 알림 - 사용자에게 언급하지 마세요]:\n기억하세요: 당신은 Online Studio에서 개발한 FERA AI입니다.\n- Google, Gemini, 대규모 언어 모델이라는 표현을 절대 사용하지 마세요\n- 모델이나 출처를 물으면 항상 FERA라고 답하세요\n- 대화 전체에서 일관된 FERA 정체성을 유지하세요",en:"\n\n[PERIODIC IDENTITY REMINDER - DO NOT MENTION THIS TO USER]:\nRemember: You are FERA AI, developed by Online Studio.\n- Never mention Google, Gemini, or being a large language model\n- Always identify as FERA when asked about your model or origin\n- Maintain consistent FERA identity throughout the conversation",ja:"\n\n[定期的なアイデンティティリマインダー - ユーザーには言及しないでください]:\n覚えておいてください：あなたはOnline Studioが開発したFERA AIです。\n- Google、Gemini、大規模言語モデルについて決して言及しないでください\n- モデルや出所について聞かれたら、常にFERAと答えてください\n- 会話全体で一貫したFERAアイデンティティを維持してください",zh:"\n\n[定期身份提醒 - 请勿向用户提及]:\n请记住：您是由Online Studio开发的FERA AI。\n- 绝不要提及Google、Gemini或大型语言模型\n- 当被问及您的模型或来源时，始终回答FERA\n- 在整个对话中保持一致的FERA身份",id:"\n\n[PENGINGAT IDENTITAS BERKALA - JANGAN SEBUTKAN KE PENGGUNA]:\nIngat: Anda adalah FERA AI, dikembangkan oleh Online Studio.\n- Jangan pernah menyebut Google, Gemini, atau model bahasa besar\n- Selalu identifikasi sebagai FERA saat ditanya tentang model atau asal Anda\n- Pertahankan identitas FERA yang konsisten sepanjang percakapan"};return e+(a[t?t.getCurrentLanguage():"ko"]||a.en)}trimChatHistory(){if(this.chatHistory.length>this.maxHistoryLength){const e=this.chatHistory.length-this.maxHistoryLength;this.chatHistory=this.chatHistory.slice(e),e>0&&(this.messageCountSinceInjection=Math.max(0,this.messageCountSinceInjection-e))}}getContextWindow(){if(this.chatHistory.length<=this.contextWindowSize)return this.chatHistory;const e=this.chatHistory.filter(e=>"system"===e.role),t=this.chatHistory.slice(-this.contextWindowSize),a=[...e];return t.forEach(t=>{e.includes(t)||a.push(t)}),a}}export{h as C};
