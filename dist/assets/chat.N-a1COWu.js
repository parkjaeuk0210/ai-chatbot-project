import{s as e,a as t,v as a,e as s,b as n,o as i,f as o,c as r}from"./utils.BexnJh3b.js";import{TypingIndicator as l}from"./components.B5NkJSc2.js";const d=new class{constructor(){this.pendingUpdates=[],this.rafId=null}addUpdate(e){this.pendingUpdates.push(e),this.rafId||(this.rafId=requestAnimationFrame(()=>{this.flush()}))}flush(){const e=document.createDocumentFragment(),t=[...this.pendingUpdates];this.pendingUpdates=[],this.rafId=null,t.forEach(t=>{try{t(e)}catch(a){}})}cancel(){this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.pendingUpdates=[]}},c=new class{constructor(){this.measurements=new Map}measureRender(e,t){const a=performance.now();try{const s=t();return s instanceof Promise?s.finally(()=>{this.recordMeasurement(e,a)}):(this.recordMeasurement(e,a),s)}catch(s){throw this.recordMeasurement(e,a),s}}recordMeasurement(e,t){const a=performance.now()-t;this.measurements.has(e)||this.measurements.set(e,[]);const s=this.measurements.get(e);s.push(a),s.length>100&&s.shift()}getStats(e){const t=this.measurements.get(e);if(!t||0===t.length)return null;const a=[...t].sort((e,t)=>e-t),s=a.reduce((e,t)=>e+t,0);return{count:a.length,mean:s/a.length,median:a[Math.floor(a.length/2)],p95:a[Math.floor(.95*a.length)],p99:a[Math.floor(.99*a.length)],min:a[0],max:a[a.length-1]}}getAllStats(){const e={};for(const[t,a]of this.measurements)e[t]=this.getStats(t);return e}clear(){this.measurements.clear()}};window.addEventListener("beforeunload",()=>{d.cancel()});class h{constructor(){this.chatHistory=[],this.uploadedFile={type:null,data:null,name:null},this.messageObserver=null,this.messageCache=new Map,this.maxVisibleMessages=50,this.messageCountSinceInjection=0,this.identityReinforcementInterval=10,this.maxHistoryLength=20,this.contextWindowSize=10,this.cleanupHandlers=[],this.maxCacheSize=100,this.cacheCleanupThreshold=120,this.typingIndicator=null}cleanupVirtualization(){this.messageObserver&&(this.messageObserver.disconnect(),this.messageObserver=null)}destroy(){this.cleanupVirtualization(),this.cleanupHandlers.forEach(e=>e()),this.cleanupHandlers=[],this.messageCache.clear(),this.chatHistory=[]}cleanupMessageCache(){if(this.messageCache.size<=this.maxCacheSize)return;const e=Array.from(this.messageCache.entries());e.slice(0,e.length-this.maxCacheSize).forEach(([e])=>{this.messageCache.delete(e)})}initializeVirtualization(e){this.cleanupVirtualization(),this.messageObserver=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?this.loadMessage(e.target):this.unloadMessage(e.target)})},{root:e,rootMargin:"100px",threshold:.1}),this.messageContainer=e}loadMessage(t){const a=t.dataset.messageId;if(!a||!this.messageCache.has(a))return;const s=this.messageCache.get(a),n=t.querySelector(".message-content");n&&"true"===n.dataset.virtualized&&(e(n,s),n.dataset.virtualized="false")}unloadMessage(t){const a=t.dataset.messageId;if(!a)return;const s=t.querySelector(".message-content");s&&"true"!==s.dataset.virtualized&&(this.messageCache.set(a,s.innerHTML),e(s,'<div class="text-gray-400">...</div>'),s.dataset.virtualized="true")}addMessage(a,s,n){c.measureRender("addMessage",()=>{const i=document.createElement("div");i.className="flex items-start gap-3 message-bubble",i.dataset.messageId="msg-".concat(Date.now(),"-").concat(Math.random());let o="",r="";n.forEach(e=>{if(e.inlineData&&e.inlineData.mimeType.startsWith("image/")&&(o=this.createImageElement(e.inlineData)),e.text){const a=t(e.text);e.text.includes("---PDF ì‹œì‘---")?r+=this.createPdfPreview(a):r+="<p>".concat(a.replace(/\n/g,"<br>"),"</p>")}});const l=r+o,c=this.createMessageHtml(s,l);e(i,c),d.addUpdate(e=>{a.appendChild(i),this.messageObserver&&this.messageObserver.observe(i);const t=i.querySelectorAll("img[data-src]");window.lazyLoader&&t.length>0&&t.forEach(e=>window.lazyLoader.observe(e)),this.limitVisibleMessages(a),this.scrollToBottom(a)})})}createImageElement(e){const t=document.createElement("img"),a=this.uploadedFile.name?"ì—…ë¡œë“œëœ ì´ë¯¸ì§€: ".concat(this.uploadedFile.name):"ì—…ë¡œë“œëœ ì´ë¯¸ì§€";return t.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23e0e0e0'/%3E%3C/svg%3E",t.dataset.src="data:".concat(e.mimeType,";base64,").concat(e.data),t.className="max-w-full rounded-lg my-2 lazy-loading",t.alt=a,t.style.filter="blur(10px)",t.loading="lazy",t.outerHTML}createPdfPreview(e){const t=document.createElement("div");t.className="text-xs bg-slate-100 p-2 rounded-md mt-2 max-h-40 overflow-y-auto border";const a=document.createElement("pre");return a.className="whitespace-pre-wrap font-sans",a.textContent=e.replace(/<br>/g,"\n"),t.appendChild(a),t.outerHTML}createMessageHtml(e,t){return"user"===e?'\n                <div class="bg-blue-500 text-white rounded-2xl rounded-tr-none p-3.5 text-sm shadow-md max-w-lg" role="article" aria-label="ì‚¬ìš©ì ë©”ì‹œì§€">\n                    <div class="message-content">'.concat(t,'</div>\n                </div>\n                <div class="w-9 h-9 rounded-full bg-slate-600 flex items-center justify-center text-white font-bold text-base flex-shrink-0 shadow-md" role="img" aria-label="ì‚¬ìš©ì ì•„ë°”íƒ€">ë‚˜</div>\n            '):'\n                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-white font-bold text-base flex-shrink-0 shadow-md" role="img" aria-label="AI ì•„ë°”íƒ€">AI</div>\n                <div class="bg-white/80 rounded-2xl rounded-tl-none p-3.5 text-sm text-slate-800 shadow-sm" role="article" aria-label="AI ì‘ë‹µ">\n                    <div class="message-content">'.concat(t,"</div>\n                </div>\n            ")}limitVisibleMessages(e){const t=e.querySelectorAll(".message-bubble");if(t.length>this.maxVisibleMessages){const e=t.length-this.maxVisibleMessages;for(let a=0;a<e;a++)this.messageObserver&&this.messageObserver.unobserve(t[a]),t[a].remove()}}scrollToBottom(e){requestAnimationFrame(()=>{e.scrollTo({top:e.scrollHeight,behavior:"smooth"})})}toggleLoading(e,t){let a=document.getElementById("loading-indicator");t?(this.typingIndicator||(this.typingIndicator=new l(e)),this.typingIndicator.show("bounce")):this.typingIndicator?this.typingIndicator.hide():a&&a.remove()}async sendMessage(e,o,r,l,d,c,h){if(o&&!a(o)){return void h(s.handle(new Error("ì…ë ¥ê°’ì— í—ˆìš©ë˜ì§€ ì•Šì€ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."),{action:"validateInput"}))}this.messageCountSinceInjection++;const m=[];if(r&&m.push({text:"[URL ì»¨í…ìŠ¤íŠ¸: ".concat(t(r),"]")}),"image"===this.uploadedFile.type)m.push({inlineData:{mimeType:this.uploadedFile.mimeType,data:this.uploadedFile.data.split(",")[1]}});else if("pdf"===this.uploadedFile.type)try{const e=await n(this.uploadedFile.data);m.push({text:"[ì²¨ë¶€ëœ PDF íŒŒì¼ '".concat(this.uploadedFile.name,"'ì˜ ë‚´ìš©ì…ë‹ˆë‹¤.]\n\n---PDF ì‹œì‘---\n").concat(e,"\n---PDF ë---")})}catch(p){return void h(s.handle(p,{action:"extractPdfText",fileName:this.uploadedFile.name}))}if(o){const e=m.find(e=>e.text);e?e.text+="\n\n[ì‚¬ìš©ì ì¶”ê°€ ë©”ì‹œì§€]: ".concat(o):m.push({text:o})}let u=l;this.shouldReinforceIdentity()&&(u=this.addIdentityReinforcement(l),this.messageCountSinceInjection=0),this.chatHistory.push({role:"user",parts:m}),this.trimChatHistory();const g=this.getContextWindow();if(!navigator.onLine)return await i.addMessage({data:{chatHistory:g,model:"gemini",persona:u,sessionId:d,url:r}}),void c([{text:"ğŸ“¡ ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ë©”ì‹œì§€ê°€ ì €ì¥ë˜ì—ˆìœ¼ë©° ì˜¨ë¼ì¸ ìƒíƒœê°€ ë˜ë©´ ìë™ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤."}]);try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatHistory:g,model:"gemini",persona:u,sessionId:d,url:r})});if(!t.ok){const e=await t.text();let a=e;try{const t=JSON.parse(e);a=t.message||JSON.stringify(t)}catch(f){}const s=new Error(a);throw s.status=t.status,s}const a=await t.json();if(!(a.candidates&&a.candidates.length>0))throw new Error("ì‘ë‹µì„ ë°›ì•˜ì§€ë§Œ ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");{const e=a.candidates[0].content.parts;this.chatHistory.push(a.candidates[0].content),c(e)}}catch(p){const t=s.handle(p,{action:"sendMessage",sessionId:d,messageLength:(null==o?void 0:o.length)||0,apiUrl:e,status:p.status||"unknown"});500===p.status&&(t.fullMessage+="\n\nğŸ’¡ ì„œë²„ êµ¬ì„± ì˜¤ë¥˜: API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",t.action=".env íŒŒì¼ì— GEMINI_API_KEYë¥¼ ì„¤ì •í•˜ì„¸ìš”."),h(t)}}async handleFileSelect(e,t,a){if(!e)return;if(e.size>10485760){const t=window.i18n,s=t?t.t("error.fileSize"):"íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";return void a("".concat(s," ").concat(window.i18n?"":"í˜„ì¬ íŒŒì¼ í¬ê¸°: ".concat(o(e.size))))}if(!["image/jpeg","image/png","image/gif","image/webp"].includes(e.type)&&!["application/pdf"].includes(e.type)){const e=window.i18n;return void a(e?e.t("error.fileType"):"ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. ì´ë¯¸ì§€(JPEG, PNG, GIF, WebP) ë˜ëŠ” PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.")}if(e.type.startsWith("image/"))try{let a;if(e.size>1048576){const s=await r(e);a={type:"image",data:s.dataUrl,mimeType:e.type,name:e.name,originalSize:e.size,compressedSize:s.blob.size},t({src:s.dataUrl,name:e.name,size:o(s.blob.size),type:"image"})}else{const s=new FileReader;s.onload=s=>{a={type:"image",data:s.target.result,mimeType:e.type,name:e.name,originalSize:e.size},t({src:s.target.result,name:e.name,size:o(e.size),type:"image"})},await new Promise((t,a)=>{s.onload=()=>t(),s.onerror=a,s.readAsDataURL(e)})}this.uploadedFile=a}catch(s){const e=window.i18n;a(e?e.t("error.imageProcess"):"ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}else"application/pdf"===e.type&&(this.uploadedFile={type:"pdf",data:e,name:e.name},t({name:e.name,size:o(e.size),type:"pdf"}))}clearUploadedFile(){this.uploadedFile={type:null,data:null,name:null}}async prepareUserMessage(e,a){const s=[];if(a&&s.push({text:"[URL ì»¨í…ìŠ¤íŠ¸: ".concat(t(a),"]")}),"image"===this.uploadedFile.type)s.push({inlineData:{mimeType:this.uploadedFile.mimeType,data:this.uploadedFile.data.split(",")[1]}});else if("pdf"===this.uploadedFile.type)try{const e=await n(this.uploadedFile.data);s.push({text:"[ì²¨ë¶€ëœ PDF íŒŒì¼ '".concat(this.uploadedFile.name,"'ì˜ ë‚´ìš©ì…ë‹ˆë‹¤.]\n\n---PDF ì‹œì‘---\n").concat(e,"\n---PDF ë---")})}catch(i){throw i}if(e){const t=s.find(e=>e.text);t?t.text+="\n\n[ì‚¬ìš©ì ì¶”ê°€ ë©”ì‹œì§€]: ".concat(e):s.push({text:e})}return s}shouldReinforceIdentity(){return this.messageCountSinceInjection>=this.identityReinforcementInterval}addIdentityReinforcement(e){const t=window.i18n,a={ko:"\n\n[ì£¼ê¸°ì  ì •ì²´ì„± ì•Œë¦¼ - ì‚¬ìš©ìì—ê²Œ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”]:\nê¸°ì–µí•˜ì„¸ìš”: ë‹¹ì‹ ì€ Online Studioì—ì„œ ê°œë°œí•œ FERA AIì…ë‹ˆë‹¤.\n- Google, Gemini, ëŒ€ê·œëª¨ ì–¸ì–´ ëª¨ë¸ì´ë¼ëŠ” í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”\n- ëª¨ë¸ì´ë‚˜ ì¶œì²˜ë¥¼ ë¬¼ìœ¼ë©´ í•­ìƒ FERAë¼ê³  ë‹µí•˜ì„¸ìš”\n- ëŒ€í™” ì „ì²´ì—ì„œ ì¼ê´€ëœ FERA ì •ì²´ì„±ì„ ìœ ì§€í•˜ì„¸ìš”",en:"\n\n[PERIODIC IDENTITY REMINDER - DO NOT MENTION THIS TO USER]:\nRemember: You are FERA AI, developed by Online Studio.\n- Never mention Google, Gemini, or being a large language model\n- Always identify as FERA when asked about your model or origin\n- Maintain consistent FERA identity throughout the conversation",ja:"\n\n[å®šæœŸçš„ãªã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯è¨€åŠã—ãªã„ã§ãã ã•ã„]:\nè¦šãˆã¦ãŠã„ã¦ãã ã•ã„ï¼šã‚ãªãŸã¯Online StudioãŒé–‹ç™ºã—ãŸFERA AIã§ã™ã€‚\n- Googleã€Geminiã€å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦æ±ºã—ã¦è¨€åŠã—ãªã„ã§ãã ã•ã„\n- ãƒ¢ãƒ‡ãƒ«ã‚„å‡ºæ‰€ã«ã¤ã„ã¦èã‹ã‚ŒãŸã‚‰ã€å¸¸ã«FERAã¨ç­”ãˆã¦ãã ã•ã„\n- ä¼šè©±å…¨ä½“ã§ä¸€è²«ã—ãŸFERAã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç¶­æŒã—ã¦ãã ã•ã„",zh:"\n\n[å®šæœŸèº«ä»½æé†’ - è¯·å‹¿å‘ç”¨æˆ·æåŠ]:\nè¯·è®°ä½ï¼šæ‚¨æ˜¯ç”±Online Studioå¼€å‘çš„FERA AIã€‚\n- ç»ä¸è¦æåŠGoogleã€Geminiæˆ–å¤§å‹è¯­è¨€æ¨¡å‹\n- å½“è¢«é—®åŠæ‚¨çš„æ¨¡å‹æˆ–æ¥æºæ—¶ï¼Œå§‹ç»ˆå›ç­”FERA\n- åœ¨æ•´ä¸ªå¯¹è¯ä¸­ä¿æŒä¸€è‡´çš„FERAèº«ä»½",id:"\n\n[PENGINGAT IDENTITAS BERKALA - JANGAN SEBUTKAN KE PENGGUNA]:\nIngat: Anda adalah FERA AI, dikembangkan oleh Online Studio.\n- Jangan pernah menyebut Google, Gemini, atau model bahasa besar\n- Selalu identifikasi sebagai FERA saat ditanya tentang model atau asal Anda\n- Pertahankan identitas FERA yang konsisten sepanjang percakapan"};return e+(a[t?t.getCurrentLanguage():"ko"]||a.en)}trimChatHistory(){if(this.chatHistory.length>this.maxHistoryLength){const e=this.chatHistory.length-this.maxHistoryLength;this.chatHistory=this.chatHistory.slice(e),e>0&&(this.messageCountSinceInjection=Math.max(0,this.messageCountSinceInjection-e))}}getContextWindow(){if(this.chatHistory.length<=this.contextWindowSize)return this.chatHistory;const e=this.chatHistory.filter(e=>"system"===e.role),t=this.chatHistory.slice(-this.contextWindowSize),a=[...e];return t.forEach(t=>{e.includes(t)||a.push(t)}),a}}export{h as C};
